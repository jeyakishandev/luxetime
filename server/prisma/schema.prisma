// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         Int     @id @default(autoincrement())
  nom        String
  prenom     String
  email      String  @unique
  motDePasse String
  telephone  String?
  role       Role    @default(CLIENT)

  // Adresse
  adresseRue        String?
  adresseVille      String?
  adresseCodePostal String?
  adressePays       String?

  // Reset password
  resetPasswordToken   String?
  resetPasswordExpires DateTime?

  // Relations
  panier      PanierItem[]
  commandes   Commande[]
  avis        Avis[]
  favoris     Favori[]
  certificats CertificatAuthenticite[]
  garanties   Garantie[]
  retours     Retour[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Produit {
  id          Int       @id @default(autoincrement())
  nom         String    @unique
  description String
  prix        Float
  prixPromo   Float?
  marque      String
  reference   String    @unique
  categorie   Categorie
  stock       Int       @default(0)

  // Caractéristiques techniques
  mouvement String?
  boitier   String?
  bracelet  String?
  etanche   String?
  diametre  String?
  poids     String?

  // Métadonnées
  tags        String[]
  estEnVente  Boolean  @default(true)
  estNouveau  Boolean  @default(false)
  noteMoyenne Float    @default(0)
  nombreAvis  Int      @default(0)
  vues        Int      @default(0)

  // Relations
  images        ImageProduit[]
  panierItems   PanierItem[]
  commandeItems CommandeItem[]
  avis          Avis[]
  favoris       Favori[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("produits")
}

model ImageProduit {
  id            Int     @id @default(autoincrement())
  url           String
  alt           String  @default("")
  estPrincipale Boolean @default(false)
  produitId     Int
  produit       Produit @relation(fields: [produitId], references: [id], onDelete: Cascade)

  @@map("image_produits")
}

model PanierItem {
  id        Int     @id @default(autoincrement())
  quantite  Int     @default(1)
  userId    Int
  produitId Int
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  produit   Produit @relation(fields: [produitId], references: [id], onDelete: Cascade)

  @@unique([userId, produitId])
  @@map("panier_items")
}

model Commande {
  id     Int            @id @default(autoincrement())
  numero String         @unique
  statut StatutCommande @default(EN_ATTENTE)

  // Client
  clientId Int
  client   User @relation(fields: [clientId], references: [id])

  // Adresses
  adresseLivraisonNom        String
  adresseLivraisonPrenom     String
  adresseLivraisonRue        String
  adresseLivraisonVille      String
  adresseLivraisonCodePostal String
  adresseLivraisonPays       String
  adresseLivraisonTelephone  String

  adresseFacturationNom        String
  adresseFacturationPrenom     String
  adresseFacturationRue        String
  adresseFacturationVille      String
  adresseFacturationCodePostal String
  adresseFacturationPays       String

  // Totaux
  sousTotal      Float
  fraisLivraison Float @default(0)
  reduction      Float @default(0)
  total          Float

  // Paiement
  methodePaiement MethodePaiement
  transactionId   String?

  // Livraison
  dateLivraison DateTime?
  numeroSuivi   String?
  notes         String?

  // Relations
  items      CommandeItem[]
  livraisons Livraison[]
  retours    Retour[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("commandes")
}

model CommandeItem {
  id           Int      @id @default(autoincrement())
  quantite     Int
  prixUnitaire Float
  nomProduit   String
  commandeId   Int
  produitId    Int
  numeroSerie  String? // Numéro de série unique pour produits de luxe
  commande     Commande @relation(fields: [commandeId], references: [id], onDelete: Cascade)
  produit      Produit  @relation(fields: [produitId], references: [id])

  // Relations
  certificat CertificatAuthenticite?
  garantie   Garantie?

  @@map("commande_items")
}

model Avis {
  id          Int     @id @default(autoincrement())
  note        Int // 1-5
  commentaire String?
  userId      Int
  produitId   Int
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  produit     Produit @relation(fields: [produitId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())

  @@unique([userId, produitId])
  @@map("avis")
}

model Favori {
  id        Int     @id @default(autoincrement())
  userId    Int
  produitId Int
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  produit   Produit @relation(fields: [produitId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())

  @@unique([userId, produitId])
  @@map("favoris")
}

// Enums
enum Role {
  CLIENT
  ADMIN
}

enum Categorie {
  HOMME
  FEMME
  UNISEXE
  VINTAGE
  SPORT
}

enum StatutCommande {
  EN_ATTENTE
  CONFIRMEE
  EN_PREPARATION
  EXPEDIEE
  LIVREE
  ANNULEE
}

enum MethodePaiement {
  CARTE
  PAYPAL
  VIREMENT
}

// ============================================
// NOUVEAUX MODÈLES POUR FONCTIONNALITÉS LUXE
// ============================================

// Certificat d'authenticité pour produits de luxe
model CertificatAuthenticite {
  id               Int     @id @default(autoincrement())
  numeroCertificat String  @unique // Numéro unique du certificat
  qrCode           String? // URL ou code QR pour vérification
  pdfUrl           String? // URL du PDF du certificat

  // Liens
  commandeItemId Int          @unique // Un certificat par item de commande
  commandeItem   CommandeItem @relation(fields: [commandeItemId], references: [id], onDelete: Cascade)

  userId Int // Propriétaire actuel
  user   User @relation(fields: [userId], references: [id])

  // Historique de propriété (JSON pour stocker la chaîne)
  historiqueProprietaires Json? // [{date, nom, email}]

  // Métadonnées
  dateEmission DateTime @default(now())

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("certificats_authenticite")
}

// Gestion de garantie
model Garantie {
  id           Int          @id @default(autoincrement())
  typeGarantie TypeGarantie @default(FABRICANT)
  dureeMois    Int // Durée en mois (24, 36, 60)
  dateDebut    DateTime
  dateFin      DateTime
  estActive    Boolean      @default(true)

  // Liens
  commandeItemId Int          @unique
  commandeItem   CommandeItem @relation(fields: [commandeItemId], references: [id], onDelete: Cascade)

  userId Int
  user   User @relation(fields: [userId], references: [id])

  // Informations additionnelles
  conditions String? // Conditions de garantie
  notes      String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("garanties")
}

// Suivi de livraison avancé
model Livraison {
  id           Int             @id @default(autoincrement())
  numeroSuivi  String          @unique // Numéro de suivi transporteur
  transporteur String // "Colissimo", "DHL", "FedEx", etc.
  statut       StatutLivraison @default(PREPARATION)

  // Liens
  commandeId Int
  commande   Commande @relation(fields: [commandeId], references: [id], onDelete: Cascade)

  // Dates
  dateExpedition DateTime?
  dateEstimee    DateTime?
  dateLivraison  DateTime?

  // Adresse de livraison (copie au moment de l'expédition)
  adresseComplete String?

  // Suivi d'étapes (JSON pour stocker l'historique)
  historiqueEtapes Json? // [{date, statut, lieu, description}]

  // Métadonnées
  assuranceIncluse Boolean @default(true)
  signatureRequise Boolean @default(true)
  instructions     String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("livraisons")
}

// Retours et remboursements
model Retour {
  id           Int    @id @default(autoincrement())
  numeroRetour String @unique // Numéro unique du retour

  // Liens
  commandeId Int
  commande   Commande @relation(fields: [commandeId], references: [id])

  userId Int
  user   User @relation(fields: [userId], references: [id])

  // Statut
  statut StatutRetour @default(DEMANDE)

  // Raison
  raison      RaisonRetour
  description String? // Description détaillée

  // Articles retournés (JSON pour stocker les items)
  items Json // [{commandeItemId, quantite, raison}]

  // Remboursement
  montantRembourse     Float?
  methodeRemboursement String? // "CARTE", "PAYPAL", "VIREMENT"
  dateRemboursement    DateTime?

  // Expédition retour
  numeroSuiviRetour String?
  dateExpRetour     DateTime?
  dateReception     DateTime?

  // Notes
  notesAdmin  String?
  notesClient String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("retours")
}

// Enums additionnels
enum TypeGarantie {
  FABRICANT // Garantie fabricant (2 ans)
  ETENDUE_3 // Garantie étendue 3 ans
  ETENDUE_5 // Garantie étendue 5 ans
}

enum StatutLivraison {
  PREPARATION // En préparation
  EXPEDIEE // Expédiée
  EN_TRANSIT // En transit
  EN_DISTRIBUTION // En distribution
  LIVREE // Livrée
  RETOUR_EN_COURS // Retour en cours
  PROBLEME // Problème de livraison
}

enum StatutRetour {
  DEMANDE // Demande de retour
  ACCEPTEE // Acceptée
  REFUSEE // Refusée
  EN_TRANSIT // Colis en transit vers nous
  RECUE // Colis reçu
  VERIFIEE // Vérifiée
  REMBOURSEE // Remboursée
  ANNULEE // Annulée
}

enum RaisonRetour {
  DEFAUT // Défaut produit
  NON_SATISFAIT // Pas satisfait
  ERREUR_COMMANDE // Erreur de commande
  CASSE // Article cassé
  AUTRE // Autre raison
}
